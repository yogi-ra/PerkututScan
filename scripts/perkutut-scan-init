#!/bin/bash
# =============================================================
# Author:
#         - Antoni Haikal
#         - Yogi Rahman Alif
#         - Fathur Wiriansyah
#         - Joenery Pratama
#         - R.M. Sultan Arif Syaidinah Hadi
#         - Muhammad Hafiz Pratama
#         - Putri Syajah
#
# pre-push init file for Automated SAST with Nuclei
# =============================================================

PRE_PUSH_FILE="pre-push"
MAIN_SCRIPT="perkutut-scan" # This file must exist in the same directory as this script

checkDependencies() {
  local dependencies=(git)
  for dep in "${dependencies[@]}"; do
    if ! command -v "$dep" &>/dev/null; then
      echo "‚ùå Missing dependency: $dep"
      exit 1
    fi
  done
}

interactiveConfig() {
  echo "üõ†Ô∏è  Interactive setup for Nuclei SAST pre-push hook"

  read -rp "ü§ñ Enable AI analysis? (y/N): " enable_ai
  use_ai=0
  ai_host=""
  ai_model=""
  if [[ "$enable_ai" =~ ^[Yy]$ ]]; then
    use_ai=1
    read -rp "üåê AI host URL [default: http://localhost:11434]: " ai_host
    read -rp "üß† AI model [default: gemma3:latest]: " ai_model
    ai_host="${ai_host:-http://localhost:11434}"
    ai_model="${ai_model:-gemma3:latest}"
  fi

  USE_AI=$use_ai
  AI_HOST="$ai_host"
  AI_MODEL="$ai_model"

  echo "‚úÖ Configuration saved"
}

installHook() {
  local git_root
  local script_dir

  script_dir="$(dirname "$(realpath "$0")")"
  git_root="$(git rev-parse --show-toplevel)"

  script_path="$script_dir/$MAIN_SCRIPT"
  crafted_args=("-m" "git" "-t" "$git_root")
  if [[ "$USE_AI" -eq 1 ]]; then
    crafted_args+=("--ai" "--aih" "$AI_HOST" "--aim" "$AI_MODEL")
  fi

  echo "CRAFTED PRE-PUSH HOOK: $script_path ${crafted_args[*]}"

  cat <<EOF >"$git_root/.git/hooks/$PRE_PUSH_FILE"
#!/bin/bash

# Redirect input/output to /dev/tty to ensure user interaction
exec < /dev/tty
exec > /dev/tty 2>&1

$script_path ${crafted_args[@]}
status=\$?

if [[ \$status -ne 0 ]]; then
  echo "üö® Nuclei SAST detected issues in your codebase."
  read -rp "üìÑ Check the report before pushing? (y/n): " check_report
  if [[ "\$check_report" =~ ^[Yy]$ ]]; then
    if command -v less &>/dev/null; then
      less sast-report.txt
    else
      cat sast-report.txt
    fi
  fi

  read -rp "‚ùì Proceed with push anyway? (y/n): " proceed
  if [[ ! "\$proceed" =~ ^[Yy]$ ]]; then
    echo "‚ùå Push aborted."
    exit 1
  else
    echo "‚ö†Ô∏è Push continued despite issues."
  fi
fi
EOF

  chmod +x "$git_root/.git/hooks/$PRE_PUSH_FILE"
  echo "‚úÖ Git hook installed at: $git_root/.git/hooks/$PRE_PUSH_FILE"
}

main() {
  USE_AI=0
  AI_HOST=""
  AI_MODEL=""

  checkDependencies
  interactiveConfig
  installHook
}

main "$@"
