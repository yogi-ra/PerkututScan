#!/bin/bash
# =============================================================
# Author:
#         - Antoni Haikal
#         - Yogi Rahman Alif
#         - Fathur Wiriansyah
#         - Joenery Pratama
#         - R.M. Sultan Arif Syaidinah Hadi
#         - Muhammad Hafiz Pratama
#         - Putri Syajah
#
# pre-push init file for Automated SAST with Nuclei
# =============================================================

PRE_PUSH_FILE="pre-push"
MAIN_SCRIPT="perkutut-scan" # This file must exist in the same directory as this script

checkDependencies() {
  local dependencies=(git)
  for dep in "${dependencies[@]}"; do
    if ! command -v "$dep" &>/dev/null; then
      echo "‚ùå Missing dependency: $dep"
      exit 1
    fi
  done
}

interactiveConfig() {
  echo "üõ†Ô∏è  Interactive setup for Nuclei SAST pre-push hook"

  read -rp "ü§ñ Enable AI analysis? (y/N): " enable_ai
  use_ai=0
  ai_host="http://localhost:11434/v1"
  ai_model="gemma3:latest"
  ai_batch_size="5"
  ai_api_key="ollama"

  if [[ "$enable_ai" =~ ^[Yy]$ ]]; then
    use_ai=1

    read -rp "üåê AI host URL [default: $ai_host]: " input
    [[ -n "$input" ]] && ai_host="$input"

    read -rp "üß† AI model [default: $ai_model]: " input
    [[ -n "$input" ]] && ai_model="$input"

    read -rp "üì¶ AI batch size [default: $ai_batch_size]: " input
    [[ -n "$input" ]] && ai_batch_size="$input"

    read -rp "üîë AI API key if required [default: $ai_api_key]: " input
    [[ -n "$input" ]] && ai_api_key="$input"
  fi

  USE_AI=$use_ai
  AI_HOST="$ai_host"
  AI_MODEL="$ai_model"
  AI_BATCH_SIZE="$ai_batch_size"
  AI_API_KEY="$ai_api_key"

  echo "‚úÖ Configuration saved"
}

installHook() {
  local git_root
  local script_dir

  script_dir="$(dirname "$(realpath "$0")")"
  git_root="$(git rev-parse --show-toplevel)"

  script_path="$script_dir/$MAIN_SCRIPT"
  crafted_args=("-m" "git" "-t" "$git_root")

  if [[ "$USE_AI" -eq 1 ]]; then
    crafted_args+=("--ai")
    [[ -n "$AI_HOST" ]] && crafted_args+=("--aih" "$AI_HOST")
    [[ -n "$AI_MODEL" ]] && crafted_args+=("--aim" "$AI_MODEL")
    [[ -n "$AI_BATCH_SIZE" ]] && crafted_args+=("--aib" "$AI_BATCH_SIZE")
    [[ -n "$AI_API_KEY" ]] && crafted_args+=("--aik" "$AI_API_KEY")
  fi

  echo "CRAFTED PRE-PUSH HOOK: $script_path ${crafted_args[*]}"

  cat <<EOF >"$git_root/.git/hooks/$PRE_PUSH_FILE"
#!/bin/bash

# Redirect input/output to /dev/tty to ensure user interaction
exec < /dev/tty
exec > /dev/tty 2>&1

$script_path ${crafted_args[@]}
status=\$?

if [[ \$status -ne 0 ]]; then
  echo "üö® Nuclei SAST detected issues in your codebase."
  read -rp "üìÑ Check the report before pushing? (y/n): " check_report
  if [[ "\$check_report" =~ ^[Yy]$ ]]; then
    if command -v less &>/dev/null; then
      less sast-report.txt
    else
      cat sast-report.txt
    fi
  fi

  read -rp "‚ùì Proceed with push anyway? (y/N): " proceed
  if [[ ! "\$proceed" =~ ^[Yy]$ ]]; then
    echo "‚ùå Push aborted."
    exit 1
  else
    echo "‚ö†Ô∏è Push continued despite issues."
  fi
fi
EOF

  chmod +x "$git_root/.git/hooks/$PRE_PUSH_FILE"
  echo "‚úÖ Git hook installed at: $git_root/.git/hooks/$PRE_PUSH_FILE"
}

main() {
  USE_AI=0
  AI_HOST=""
  AI_MODEL=""
  AI_BATCH_SIZE=""
  AI_API_KEY=""

  checkDependencies
  interactiveConfig
  installHook
}

main "$@"
